# üåä Kelani Ganga Flood Prediction System - Setup Guide

## Step-by-Step Installation

### Step 1: Install PostgreSQL

1. Download PostgreSQL from https://www.postgresql.org/download/
2. Install with default settings
3. Remember your postgres password (should be 'root' as configured)
4. Verify installation:
```bash
psql --version
```

### Step 2: Install Node.js Dependencies

```bash
cd ENV_RISK_BACKEND
npm install
```

Expected packages:
- express
- pg (PostgreSQL client)
- cors
- axios
- dotenv
- morgan
- body-parser
- csv-parser
- node-cron (for weather scheduler)
- nodemon (dev)

### Step 3: Install Python Dependencies

```bash
cd ENV_RISK_BACKEND
pip install -r requirements.txt
```

Expected packages:
- fastapi
- uvicorn
- pydantic
- pandas
- numpy
- scikit-learn
- xgboost

### Step 4: Train the ML Model

1. Open the Jupyter Notebook:
```bash
jupyter notebook Kelani_Ganga_Flood_Prediction.ipynb
```

2. Run all cells (Cell ‚Üí Run All)
3. Verify that `flood_prediction_model.pkl` is created
4. Check console output for "MODEL SAVED FOR BACKEND DEPLOYMENT"

### Step 5: Initialize Database

```bash
cd ENV_RISK_BACKEND
npm run init-db
```

This will:
- Create the `flood_prediction` database
- Create tables: stations, water_levels, predictions, alerts, weather_data, users
- Insert initial station data (8 monitoring stations)
- Create views and indexes
- Set up weather data storage
- Initialize user authentication system

### Step 6: Seed Historical Data (Optional)

```bash
npm run seed
```

This imports historical water level data from the CSV file generated by the notebook.

### Step 7: Install Frontend Dependencies

```bash
cd ../ENV_RISK_FRONTEND
npm install
```

### Step 8: Start the Services

**Option A: Use the Startup Script (Recommended for Windows)**
```bash
cd ..
start.bat
```

**Option B: Manual Start (3 separate terminals)**

Terminal 1 - FastAPI ML Service:
```bash
cd ENV_RISK_BACKEND
python ml_service.py
```

Terminal 2 - Express Backend:
```bash
cd ENV_RISK_BACKEND
npm start
```

Terminal 3 - Next.js Frontend:
```bash
cd ENV_RISK_FRONTEND
npm run dev
```

### Step 9: Verify Everything is Running

1. **FastAPI ML Service**: http://localhost:8000
   - Should show: "Kelani Ganga Flood Prediction ML Service"
   - Check: http://localhost:8000/docs for API documentation

2. **Express Backend**: http://localhost:5000
   - Should show API info with endpoints
   - Test: http://localhost:5000/health

3. **Next.js Frontend**: http://localhost:3000
   - Should load the dashboard

### Step 10: Test the API

**Get all stations:**
```bash
curl http://localhost:5000/api/stations
```

**Get latest water levels:**
```bash
curl http://localhost:5000/api/water-levels/latest
```

**Make a prediction:**
```bash
curl -X POST http://localhost:8000/predict \
  -H "Content-Type: application/json" \
  -d '{
    "station": "Kitulgala",
    "water_level_previous": 3.5,
    "rainfall": 50,
    "trend": 1,
    "alert_level": 3.0,
    "minor_flood_level": 4.0,
    "major_flood_level": 5.0
  }'
```

**Get current weather:**
```bash
curl http://localhost:5000/api/weather/current
```

**Register a user:**
```bash
curl -X POST http://localhost:5000/api/register \
  -H "Content-Type: application/json" \
  -d '{
    "fullName": "John Doe",
    "phoneNumber": "+94771234567",
    "email": "john@example.com",
    "address": "hanwella",
    "alertMethods": ["SMS", "WhatsApp"],
    "riskLevels": ["Critical", "High"],
    "language": "en"
  }'
```

**Login:**
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phoneNumber": "+94771234567",
    "password": "yourpassword"
  }'
```

## Troubleshooting

### PostgreSQL Connection Error
```
Error: connect ECONNREFUSED 127.0.0.1:5432
```

**Solution:**
1. Ensure PostgreSQL service is running
2. Check credentials in `.env` file
3. Verify port 5432 is not blocked

### Weather Data Not Showing
```
Weather Widget shows "Loading..." or errors
```

**Solution:**
1. Check OpenWeather API key in `.env`
2. Verify weather scheduler is running (check console logs)
3. Check database has weather_data table
4. Run: `SELECT * FROM weather_data LIMIT 1;`

### Login/Registration Not Working
```
Login failed or registration error
```

**Solution:**
1. Verify users table exists with password_hash column
2. Check auth routes are loaded in server.js
3. Clear browser localStorage if needed
4. Check backend logs for specific errors

### Model Not Found Error
```
Error loading model: [Errno 2] No such file or directory: 'flood_prediction_model.pkl'
```

**Solution:**
1. Run the Jupyter notebook completely
2. Ensure the second cell (model saving) executed successfully
3. Check that `flood_prediction_model.pkl` exists in `ENV_RISK_BACKEND/`

### FastAPI Import Error
```
ModuleNotFoundError: No module named 'fastapi'
```

**Solution:**
```bash
pip install -r requirements.txt
```

### Frontend Cannot Connect to Backend
```
API Error (/stations): Failed to fetch
```

**Solution:**
1. Ensure Express backend is running on port 5000
2. Check `.env.local` has correct `NEXT_PUBLIC_API_URL`
3. Verify CORS is enabled in Express

### Port Already in Use
```
Error: listen EADDRINUSE: address already in use :::5000
```

**Solution:**
- Change port in `.env` file
- Or kill the process using the port:
```bash
# Windows
netstat -ano | findstr :5000
taskkill /PID <PID> /F

# Linux/Mac
lsof -ti:5000 | xargs kill -9
```

## Environment Variables Reference

### Backend (.env)
```env
DB_HOST=localhost          # PostgreSQL host
DB_PORT=5432              # PostgreSQL port
DB_NAME=flood_prediction  # Database name
DB_USER=postgres          # Database user
DB_PASSWORD=root          # Database password

# Weather API (OpenWeather)
OPENWEATHER_API_KEY=b96b067dcb0499fd8f83ec5660ec8154

# NASA Earthdata Token (Optional - for external flood data)
NASA_EARTHDATA_TOKEN=your_nasa_token_here

# Frontend URL
FRONTEND_URL=http://localhost:3000
PORT=5000                 # Express server port
ML_SERVICE_URL=http://localhost:8000  # FastAPI URL
```

### Frontend (.env.local)
- 8 monitoring stations along Kelani Ganga

### water_levels
- Historical water level measurements
- Linked to stations

### predictions
SELECT * FROM users;      # View registered users
SELECT * FROM weather_data ORDER BY recorded_at DESC LIMIT 5;  # Latest weather
\q                        # Quit

# Testing
# Visit pages
http://localhost:3000              # Home
http://localhost:3000/dashboard    # Dashboard
http://localhost:3000/register     # Registration
http://localhost:3000/login        # Login
http://localhost:3000/predictions  # Forecasts
http://localhost:3000/alerts       # Alerts
- 7-day forecasts

### alerts
- Active flood alerts
- Linked to stations

### weather_data
- OpenWeather API data storage
- Temperature, humidity, rainfall, wind
- Hourly updates with scheduler
- Kelani Ganga Basin location

### users
- User registration and authentication
- Phone number, email, preferences
- Alert methods and risk level settings
- Password authentication (SHA256)evel measurements
- Linked to stations

### predictions
- ML model predictions
- 7-day forecasts

### alerts
- Active flood alerts
- Linked to stations

## Quick Commands

```bash
# Backend
cd ENV_RISK_BACKEND
npm iw Features

### üå¶Ô∏è Weather Integration
- **OpenWeather API** integration for real-time weather data
- Automatic hourly updates via scheduler
- Weather-based flood risk assessment
- Display: Temperature, rainfall, humidity, wind speed

### üìä Multi-Source Flood Analysis
- Your ML Model (98.2% confidence)
- NASA GFMS satellite data (optional)
- OpenWeather conditions
- Consensus prediction display

### üë• User Authentication
- **Registration System** - Users can register for personalized alerts
- **Login System** - Secure authentication with password hashing
- User preferences: Alert methods, risk levels, language
- Database: Phone number, email, notification settings

### üì± Available Pages
- `/` - Home page
- `/dashboard` - Main dashboard with live data
- `/alerts` - Flood alerts and warnings
- `/predictions` - 7-day ML forecasts
- `/register` - User registration
- `/login` - User login
- `/safety-new` - Safety guidelines
- `/about-new` - System information

## API Endpoints

### Core APIs
- `GET /api/stations` - All monitoring stations
- `GET /api/water-levels/latest` - Latest water levels
- `GET /api/predictions/forecasts` - ML predictions
- `GET /api/predictions/ml-forecast` - CSV-based forecasts
- `GET /api/alerts` - Active alerts

### Weather APIs
- `GET /api/weather/current` - Fetch and store current weather
- `GET /api/weather/latest` - Latest weather from database
- `GET /api/weather/daily` - Daily weather summary
- `GET /api/weather/history` - Weather history

### External Flood APIs
- `GET /api/external-flood/nasa-gfms` - NASA flood data
- `GET /api/external-flood/comparison` - Multi-source comparison

### User APIs
- `POST /api/register` - Register new user
- `GET /api/register` - Get all users
- `GET /api/register/:phoneNumber` - Get specific user
- `DELETE /api/register/:phoneNumber` - Deactivate user

### Authentication APIs
- `POST /api/auth/login` - User login
- `POST /api/auth/logout` - User logout
- `GET /api/auth/verify` - Verify session

## Weather Scheduler

The system automatically fetches weather data:
- **On Startup**: Immediate fetch
- **Hourly**: Every hour at minute 0
- **Daily**: 6:00 AM special update

Location: Kelani Ganga Basin (6.9271¬∞N, 79.8612¬∞E)

## Next Steps

1. ‚úÖ System is running
2. üìä View dashboard at http://localhost:3000
3. üîç Explore API at http://localhost:8000/docs
4. üìà Monitor real-time data
5. üë§ Register for personalized alerts at /register
6. üîê Login at /login for saved preferences
7. üå¶Ô∏è View weather conditions on dashboard
8. üö® Set up alert notifications
9 Frontend
cd ENV_RISK_FRONTEND
npm install               # Install dependencies
npm run dev               # Development mode
npm run build             # Production build
npm start                 # Production mode

# Database
psql -U postgres          # Connect to PostgreSQL
\l                        # List databases
\c flood_prediction       # Connect to database
\dt                       # List tables
\q                        # Quit
```

## Next Steps

1. ‚úÖ System is running
2. üìä View dashboard at http://localhost:3000
3. üîç Explore API at http://localhost:8000/docs
4. üìà Monitor real-time data
5. üö® Set up alert notifications
6. üì± Deploy to production

## Support

If you encounter issues:
1. Check this troubleshooting guide
2. Review console logs for errors
3. Verify all services are running
4. Check database connection
5. Ensure model file exists

---

**‚ö†Ô∏è Security Note:** Default passwords are for development only. Use strong passwords in production!
